رسیدیم به سطح حرفه‌ای مدیریت کلاستر Docker Swarm 🚀  
این مباحث برای مدیریت **پایدار و امن** یک Swarm واقعی و production-grade هستن. بریم به‌صورت دقیق و عملی بررسی کنیم:

---

## ✅ ۱. Promoting / Demoting Nodes (manager ↔ worker)

### 🔼 Promote:

تبدیل یک worker به manager:

```bash
docker node promote node2
```

### 🔽 Demote:

تبدیل manager به worker:

```bash
docker node demote node2
```

🧠 نکته:

- فقط Managerها می‌تونن این کار رو انجام بدن
    
- Managerها در رأی‌گیری (Raft) شرکت می‌کنن؛ بیشتر از نیاز، خطرناک می‌شه
    

---

## ✅ ۲. اضافه و حذف نودها از Swarm

### اضافه‌کردن نود:

```bash
docker swarm join --token <token> <manager-ip>:2377
```

### حذف نود (از سمت manager):

```bash
docker node rm <node-name>
```

اگر نود آفلاین باشه، باید `--force` بزنی.

---

## ✅ ۳. Drain / Pause / Active

### هدف: کنترل کدوم نودها تسک اجرا کنن یا نکنن.

- **Active**: نود می‌تونه تسک جدید بگیره (پیش‌فرض)
    
- **Pause**: مثل Active ولی تا وقتی تسک داره، نگه می‌داره
    
- **Drain**: تسک‌های نود به نودهای دیگه منتقل می‌شن (برای تعمیر/خروج)
    

### دستور:

```bash
docker node update --availability drain node2
```

---

## ✅ ۴. Swarm Raft Consensus و Quorum

Swarm از الگوریتم **Raft** برای هماهنگی بین Managerها استفاده می‌کنه.

|اصطلاح|توضیح|
|---|---|
|**Raft**|الگوریتم توزیع‌شده برای هماهنگی و اجماع|
|**Quorum**|حداقل تعداد Managerهای فعال برای ادامه‌ی کار Swarm|
|فرمول|`ceil(N / 2)` از N=تعداد Managerها|

مثال:

- اگر 3 Manager داشته باشی → باید حداقل 2 تا Active باشن
    
- اگه quorum رو از دست بدی → هیچ آپدیتی در سرویس ممکن نیست (فقط خواندن ممکنه)
    

---

## ✅ ۵. Auto-lock و Swarm Encryption

### 🔐 Auto-lock:

وقتی Auto-lock فعال باشه، هر بار Docker daemon ری‌استارت بشه، باید `unlock-key` بدی.

```bash
docker swarm update --autolock=true
docker swarm unlock-key
```

برای unlock:

```bash
docker swarm unlock
```

🔐 مناسب برای امنیت Swarm در صورت reboot/restart daemon.

---

## ✅ ۶. استفاده از TLS بین نودها

Docker Swarm **به‌صورت پیش‌فرض** ارتباط بین نودها رو با **TLS** رمزنگاری می‌کنه.

ویژگی‌ها:

- Authenticated mutual TLS
    
- Certificate rotation خودکار
    
- Private CA داخلی در Swarm
    

📌 نیاز به تنظیمات دستی نداره؛ همه‌چیز secure-by-default هست.

---

## ✅ ۷. Snapshot و Backup از Swarm (Raft state)

Swarm کل state (سرویس‌ها، نودها، configها...) رو در یک دیتابیس Raft ذخیره می‌کنه در مسیر:

```bash
/var/lib/docker/swarm/
```

### بکاپ گرفتن:

1. روی Manager Leader:
    
    ```bash
    docker node ls   # پیدا کردن leader
    ```
    
2. بکاپ:
    
    ```bash
    sudo tar czvf swarm-backup.tar.gz /var/lib/docker/swarm
    ```
    

### ریستور:

1. Stop Docker
    
2. جایگزینی `/var/lib/docker/swarm` با بکاپ
    
3. Start Docker
    

---

## 🎯 نتیجه:

این ابزارها برای موقعیت‌هایی مثل:

- ارتقاء ایمن
    
- disaster recovery
    
- migration
    
- امنیت سرویس‌های حساس
    

کاملاً ضروری هستن.

---

اگه بخوای می‌تونیم یک **سناریوی واقعی تعمیر نود، quorum failure، drain/restart/restore** طراحی کنیم تا همه رو با هم تمرین کنیم 😎 بگو آماده‌ای بریم عملی؟